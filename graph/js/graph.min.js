jQuery(document).ready(function(a){function e(){function e(a,e){var t=0;for(var r in a)t<a[r].value&&a[r].type==e&&(t=a[r].value);return t}function r(a,t){var r=t.all.list,n=r[a.index],i=(.8*(100*n.value/e(r,n.type))/100).toFixed(2);return.3>=i?.5:i}function n(a,e){var r=e.all.list,n=r[a.index],i="";switch(n.type){case"parent":i="blue";break;case"s":i="green";break;case"a":i="yellow"}return t(i)}function i(a,t){var r=t.all.list,n=r[a.target.index],i=(.8*(100*n.value/e(r,n.type))/100).toFixed(2);return.3>=i?.5:i}function s(a,e){var r=e.all.op;for(var n in r)if(n==a.source.index+":"+a.source.subindex){if(1==r[n].type)return t("yellow");if(0==r[n].type)return t("green")}return 0}function l(a,e,t,r){var a=a,e=isNaN(e=Math.abs(e))?2:e,t=void 0==t?".":t,r=void 0==r?",":r,n=0>a?"-":"",i=parseInt(a=Math.abs(+a||0).toFixed(e))+"",s=(s=i.length)>3?s%3:0;return n+(s?i.substr(0,s)+r:"")+i.substr(s).replace(/(\d{3})(?=\d)/g,"$1"+r)+(e?t+Math.abs(a-i).toFixed(e).slice(2):"")}var o=600,u=600,d=Math.min(o,u)/2-10,c=d-24,p=null,v=null,f=[];f[0]="green",f[1]="yellow",f[-1]="blue";var y=a("#tooltip"),h=a("#description"),m=d3.svg.arc().innerRadius(c).outerRadius(d),g=d3.layout.chord().padding(.01).sortSubgroups(d3.descending).sortChords(d3.ascending),x=d3.svg.chord().radius(c),b=d3.select("#graph").append("svg").attr("width",o).attr("height",u).append("g").attr("id","circle").attr("transform","translate("+o/2+","+u/2+")");this.init=function(){b.append("circle").attr("r",d),queue().defer(d3.json,"js/data.json").await(function(e,t){function o(a){var e=this;v="shord",e.addEventListener("mouseover",function(e){w(a,"chord",e.layerX,e.layerY)},!1),k(a.target)}function u(){y.hide();var e=a(".summary",h);e.html("").hide()}function d(a,e){v="group";var t=this;t.addEventListener("mouseover",function(e){w(a,"group",e.layerX,e.layerY)},!1),k(a,e),N.classed("fade",function(a){return a.target.index==e&&(p="1"),a.source.index==e&&(p="2"),a.source.index!=e&&a.target.index!=e})}function c(){var e=a(".summary",h);e.html("").hide(),y.html("").hide()}function w(a,e,t,r){var n="",i="group"==e?j[a.index]:j[a.target.index];if("group"==e)n+=i.name;else{var s=L[a.source.index+":"+a.source.subindex];n+="<div style='border-bottom: 1px #fff solid; padding-bottom: 2px; margin-bottom: 2px; '>"+i.name+"</div>",n+=""!=s.data.data?"<div>Дата: "+s.data.data+"</div>":"",n+="<div>Сумма: "+l(s.summ,0,"."," ")+"</div>"}y.html(n),y.css("top",r+15),y.css("left",t+15),y.show()}function k(e){var t=a(".summary",h),r="",n=j[e.index],i=[],s=1;if(null!==n.group||"Прочие объеты поглащения"==n.name){n.group="group1";var o=M[n.group];for(var u in o)o[u].value>s&&(s=o[u].value);for(var u in o){var d=(1*(100*o[u].value/n.value)/100).toFixed(2),c=(1*(100*o[u].value/s)/100).toFixed(2),v=f[0],y=void 0!==o[u].data?o[u].data:"";i.push({parent:o[u].parent,bank:o[u].name,value:o[u].value,color:v,percent:d,opacity:.3>c?.3:c,data:y})}r+="<ul>";for(var u in i)r+="<li class='bank'>",r+="<span class='name head'>"+i[u].parent+"</span>",r+="<span class='op' style='width: "+100*i[u].percent+"%;'>",r+="<i class='color blue' style='opacity:"+i[u].opacity+";'></i>",r+="<i class='value'>"+l(i[u].value,0,"."," ")+"</i>",r+="</span>",r+="</li>",r+="<li class='bank'>",r+="<span class='name'>"+i[u].bank+"<i class='data'>"+i[u].data+"</i></span>",r+="<span class='op' style='width: "+100*i[u].percent+"%;'>",r+="<i class='color "+i[u].color+"' style='opacity:"+i[u].opacity+";'></i>",r+="<i class='value'>"+l(i[u].value,0,"."," ")+"</i>",r+="</span>",r+="</li>";r+="</ul>",t.html(r).show()}else{var m=null,g=e.index;if(null===p&&(p="a"==j[g].type||"s"==j[g].type?1:2),("a"==n.type||"s"==n.type)&&2==p)for(var u in L){var x=u.split(":");x[0]==g&&-1!=L[u].type&&(g=x[1],n=j[g])}for(var u in L){var x=u.split(":");x[0]==g&&-1!=L[u].type&&L[u].summ>s&&(s=L[u].summ)}for(var u in L){var x=u.split(":");if(x[0]==g&&-1!=L[u].type){var d=(1*(100*L[u].summ/n.value)/100).toFixed(2),c=(1*(100*L[u].summ/s)/100).toFixed(2),v=f[L[u].type],y=void 0!==L[u].data.data?L[u].data.data:"";i.push({bank:j[x[1]],value:L[u].summ,color:v,percent:d,opacity:.3>c?.3:c,data:y}),m=u}}if(("a"==n.type||"s"==n.type)&&1==p){var b=n;n=i[0].bank,i[0].data=void 0!==L[m]?L[m].data.data:"",i[0].bank=b,i[0].percent=(1*(100*i[0].value/n.value)/100).toFixed(2)}r+="<ul>",r+="<li class='bank'>",r+="<span class='name head'>"+n.name+"</span>",r+="<span class='op'><i class='color blue' style='width: 100%'></i> <i class='value'>"+l(n.value,0,"."," ")+"</i></span>",r+="</li>";for(var u in i)r+="<li class='bank'>",r+="<span class='name'>"+i[u].bank.name+"<i class='data'>"+i[u].data+"</i></span>",r+="<span class='op' style='width: "+100*i[u].percent+"%;'>",r+="<i class='color "+i[u].color+"' style='opacity:"+i[u].opacity+";'></i>",r+="<i class='value'>"+l(i[u].bank.value,0,"."," ")+"</i>",r+="</span>",r+="</li>";r+="</ul>",t.html(r).show()}}if(e)throw e;var F=t.all.matrix,j=t.all.list,L=t.all.op,M=t.all.groups;g.matrix(F);var A=b.selectAll(".group").data(g.groups).enter().append("g").attr("class","group").on("mouseover",d).on("mouseleave",c),C=A.append("path").attr("id",function(a,e){return"group-"+e}).attr("d",m).style("fill-opacity",function(a){return r(a,t)}).style("fill",function(a){return n(a,t)}),E=A.append("text").attr("x",function(){return 7}).attr("dy",15);E.append("textPath").attr("xlink:href",function(a,e){return"#group-"+e}).text(function(a,e){return j[e].name}),E.filter(function(a,e){return C[0][e].getTotalLength()/2-30<this.getComputedTextLength()}).remove();var N=b.selectAll(".chord").data(g.chords).enter().append("path").attr("class","chord").style("stroke-width","0.5").style("stroke","#ccc").style("fill-opacity",function(a){return i(a,t)}).style("fill",function(a){return s(a,t)}).attr("d",x).on("mouseover",o).on("mouseleave",u)})}}var t=function(a){switch(a){case"green":return"rgb(223, 0, 62)";case"yellow":return"rgb(254, 163, 32)";case"blue":return"rgb(39, 196, 209)"}},r=new e;r.init()});